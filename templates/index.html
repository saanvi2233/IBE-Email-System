<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBE Email System - Final Year Project</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 35px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -5%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 2em;
        }

        .header h1 {
            color: white;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .project-info {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 18px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .info-item {
            color: rgba(255,255,255,0.95);
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .info-item::before {
            content: '‚úì';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            margin-right: 8px;
            font-size: 0.8em;
        }

        .info-item strong {
            color: white;
            margin-right: 4px;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .tab-button {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .tab-button:hover::before {
            left: 100%;
        }

        .tab-button:hover {
            background: #f8f9fa;
            color: #667eea;
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
            background: white;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .tab-content.active {
            display: block;
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dce0e4;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .result-box {
            margin-top: 18px;
            padding: 15px;
            border-radius: 6px;
            display: none;
            border-left: 4px solid;
        }

        .result-box.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .result-box.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .result-box.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .result-box h4 {
            margin-bottom: 8px;
            font-size: 1em;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            margin-top: 10px;
            line-height: 1.5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #4a90e2;
        }

        .stat-card h5 {
            color: #4a90e2;
            margin-bottom: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .stat-card p {
            color: #2c3e50;
            font-size: 1.1em;
            font-weight: 600;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid;
            font-size: 0.9em;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .alert::before {
            content: '‚ìò';
            font-size: 1.5em;
            font-weight: bold;
            flex-shrink: 0;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffc107;
            color: #856404;
        }

        .alert-warning::before {
            content: '‚ö†';
            color: #ffc107;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #a8dadc 100%);
            border-color: #17a2b8;
            color: #0c5460;
        }

        .alert-info::before {
            color: #17a2b8;
        }

        .workflow-diagram {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            position: relative;
        }

        .workflow-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .workflow-step:not(:last-child)::after {
            content: '‚Üí';
            position: absolute;
            right: -15px;
            top: 30%;
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
        }

        .workflow-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .workflow-label {
            font-size: 0.85em;
            color: #2c3e50;
            font-weight: 600;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .feature-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            transform: translateY(-3px);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 15px;
            color: white;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title::before {
            content: '';
            width: 6px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
        }

        .overview-section {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .overview-section h3 {
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overview-section h3::before {
            content: '‚óè';
            color: #667eea;
            font-size: 1.5em;
        }

        .overview-section ul {
            line-height: 2;
            color: #495057;
        }

        .overview-section ul li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 8px;
        }

        .overview-section ul li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .crypto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .crypto-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 10px;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .crypto-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transition: all 0.5s;
        }

        .crypto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .crypto-card:hover::before {
            top: -20%;
            right: -20%;
        }

        .crypto-card h4 {
            color: rgba(255,255,255,0.9);
            font-size: 0.85em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        .crypto-card p {
            color: white;
            font-size: 1.3em;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">rap
            <div class="header-content">
                <div class="header-icon">üîê</div>
                <h1>Identity-Based Encryption Email System</h1>
                <!-- <p>Final Year Cryptography Project - Interactive Demonstration</p> -->
                <!-- <div class="project-info">
                    <div class="info-item"><strong>Algorithm:</strong> X25519 + ChaCha20-Poly1305</div>
                    <div class="info-item"><strong>Key Derivation:</strong> HKDF-SHA256</div>
                    <div class="info-item"><strong>Authentication:</strong> Email OTP</div>
                    <div class="info-item"><strong>Status:</strong> Ready</div>
                </div> -->
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('overview')">üìö Overview</button>
            <button class="tab-button" onclick="showTab('demo')">üéØ Live Demo</button>
            <button class="tab-button" onclick="showTab('encrypt')">üîí Encrypt</button>
            <button class="tab-button" onclick="showTab('decrypt')">üîì Decrypt</button>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content active">
            <h2 class="section-title">Project Overview</h2>
            
            <div class="workflow-diagram">
                <div class="workflow-step">
                    <div class="workflow-icon">üîß</div>
                    <div class="workflow-label">PKG Setup</div>
                </div>
                <div class="workflow-step">
                    <div class="workflow-icon">üìß</div>
                    <div class="workflow-label">Request OTP</div>
                </div>
                <div class="workflow-step">
                    <div class="workflow-icon">üîë</div>
                    <div class="workflow-label">Extract Key</div>
                </div>
                <div class="workflow-step">
                    <div class="workflow-icon">üîí</div>
                    <div class="workflow-label">Encrypt</div>
                </div>
                <div class="workflow-step">
                    <div class="workflow-icon">üîì</div>
                    <div class="workflow-label">Decrypt</div>
                </div>
            </div>

            <div class="overview-section">
                <h3>What is Identity-Based Encryption?</h3>
                <p style="color: #495057; line-height: 1.8; font-size: 1.05em;">
                    Identity-Based Encryption (IBE) is a revolutionary cryptographic system where any string (like an email address) 
                    can be used as a public key. This eliminates the need for traditional public key infrastructure 
                    and certificate authorities, making secure communication simpler and more intuitive.
                </p>
            </div>

            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">‚úâÔ∏è</div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1em;">Simple Email-Based Encryption</h4>
                    <p style="color: #7f8c8d; line-height: 1.6;">Send encrypted messages using just the recipient's email address - no complicated key sharing needed</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üõ°Ô∏è</div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1em;">Protected Key Server</h4>
                    <p style="color: #7f8c8d; line-height: 1.6;">A trusted server creates private keys only after verifying your identity with a one-time password</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîê</div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1em;">Industry-Standard Security</h4>
                    <p style="color: #7f8c8d; line-height: 1.6;">Uses proven encryption methods trusted by major tech companies and security experts</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ö°</div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1em;">Always Fresh Keys</h4>
                    <p style="color: #7f8c8d; line-height: 1.6;">Every message gets its own unique encryption key for better protection</p>
                </div>
            </div>

            <!-- <div class="overview-section" style="margin-top: 30px;">
                <h3>Cryptographic Primitives</h3>
                <div class="crypto-grid">
                    <div class="crypto-card">
                        <h4>Key Agreement</h4>
                        <p>X25519 ECDH</p>
                    </div>
                    <div class="crypto-card">
                        <h4>Encryption</h4>
                        <p>ChaCha20-Poly1305</p>
                    </div>
                    <div class="crypto-card">
                        <h4>Key Derivation</h4>
                        <p>HKDF-SHA256</p>
                    </div>
                    <div class="crypto-card">
                        <h4>Architecture</h4>
                        <p>KEM-DEM Hybrid</p>
                    </div>
                </div>
            </div> -->

            <!-- <div class="alert alert-info">
                <div>
                    <strong style="display: block; margin-bottom: 5px;">üéì Academic Project</strong>
                    This system demonstrates IBE concepts for educational purposes. 
                    Use the "Live Demo" tab to see the complete workflow in action.
                </div>
            </div> -->
        </div>

        <!-- Encrypt Tab -->
        <div id="tab-encrypt" class="tab-content">
            <h2 class="section-title">Encrypt Message</h2>

            <div class="form-group">
                <label for="encrypt-recipient">Recipient Email:</label>
                <input type="email" id="encrypt-recipient" placeholder="bob@example.com" value="sanvimps@gmail.com">
            </div>

            <div class="form-group">
                <label for="encrypt-message">Message:</label>
                <textarea id="encrypt-message" placeholder="Enter your message...">Hello! This is a secret message encrypted with IBE.</textarea>
            </div>

            <button class="btn btn-primary" onclick="encryptMessage()">Encrypt Message</button>

            <div id="encrypt-result" class="result-box"></div>
        </div>

        <!-- Decrypt Tab -->
        <div id="tab-decrypt" class="tab-content">
            <h2 class="section-title">Decrypt Message</h2>

            <div class="alert alert-info">
                <strong>Note:</strong> First encrypt a message, then paste the envelope here to decrypt.
            </div>

            <div class="form-group">
                <label for="decrypt-identity">Your Email:</label>
                <input type="email" id="decrypt-identity" placeholder="alice@example.com" value="sanvimps@gmail.com">
            </div>

            <div class="form-group">
                <label for="decrypt-envelope">Encrypted Envelope (JSON):</label>
                <textarea id="decrypt-envelope" placeholder='{"ephemeral_pub": "...", "nonce": "...", "ciphertext": "..."}'></textarea>
            </div>

            <button class="btn btn-success" onclick="decryptMessage()">Decrypt Message</button>

            <div id="decrypt-result" class="result-box"></div>
        </div>

        <!-- Complete Demo Tab -->
        <div id="tab-demo" class="tab-content">
            <h2 class="section-title">Live Demonstration</h2>

            <p style="margin-bottom: 15px; color: #495057;">
                Complete end-to-end workflow: OTP Authentication ‚Üí Key Extraction ‚Üí Encryption ‚Üí Decryption
            </p>

            <div class="alert alert-warning">
                <strong>Prerequisite:</strong> SMTP debug server must be running on port 1025<br>
                <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px;">python scripts/debug_smtp_server.py --port 1025</code>
            </div>

            <div class="form-group">
                <label for="demo-recipient">Recipient Email:</label>
                <input type="email" id="demo-recipient" placeholder="alice@example.com" value="sanvimps@gmail.com">
            </div>

            <button class="btn btn-primary" onclick="requestDemoOTP()">Step 1: Request OTP</button>

            <div id="demo-otp-result" class="result-box"></div>

            <div id="demo-continue-section" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label for="demo-message">Test Message:</label>
                    <textarea id="demo-message" placeholder="Enter message...">Hello! This is an IBE encrypted message.</textarea>
                </div>

                <div class="form-group">
                    <label for="demo-otp">OTP Code (from SMTP console):</label>
                    <input type="text" id="demo-otp" placeholder="123456" maxlength="6">
                </div>

                <button class="btn btn-success" onclick="runCompleteDemo()">Step 2: Run Complete Flow</button>

                <div id="demo-result" class="result-box"></div>
            </div>
        </div>
    </div>

    <script>
        let lastEncryptedEnvelope = null;

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        async function requestOTP() {
            const identity = document.getElementById('extract-identity').value;
            const resultBox = document.getElementById('otp-result');
            
            if (!identity) {
                showResult(resultBox, 'error', 'Please enter an email identity');
                return;
            }

            try {
                const response = await fetch('/api/request_otp', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({identity})
                });

                const data = await response.json();

                if (response.ok) {
                    showResult(resultBox, 'success', 
                        `<h4>OTP Sent Successfully</h4>
                        <p>${data.message}</p>
                        <p style="margin-top: 8px;"><strong>Check SMTP debug server console for the 6-digit code.</strong></p>`
                    );
                    document.getElementById('otp-input-section').style.display = 'block';
                } else {
                    showResult(resultBox, 'error', `<h4>Error</h4><p>${data.error}</p>`);
                }
            } catch (error) {
                showResult(resultBox, 'error', `<h4>‚ùå Error</h4><p>${error.message}</p>`);
            }
        }

        async function extractKey() {
            const identity = document.getElementById('extract-identity').value;
            const otp = document.getElementById('otp-code').value;
            const resultBox = document.getElementById('extract-result');

            if (!identity || !otp) {
                showResult(resultBox, 'error', 'Please enter both identity and OTP');
                return;
            }

            try {
                const response = await fetch('/api/extract_key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({identity, otp})
                });

                const data = await response.json();

                if (response.ok) {
                    showResult(resultBox, 'success',
                        `<h4>Private Key Extracted</h4>
                        <p><strong>Identity:</strong> ${data.identity}</p>
                        <p style="margin-top: 8px;"><strong>Private Key (Base64):</strong></p>
                        <div class="code-block">${data.private_key}</div>
                        <p style="margin-top: 8px; font-size: 0.85em; color: #666;">
                            Key stored in session for decryption.
                        </p>`
                    );
                } else {
                    showResult(resultBox, 'error', `<h4>Error</h4><p>${data.error}</p>`);
                }
            } catch (error) {
                showResult(resultBox, 'error', `<h4>‚ùå Error</h4><p>${error.message}</p>`);
            }
        }

        async function encryptMessage() {
            const recipient = document.getElementById('encrypt-recipient').value;
            const message = document.getElementById('encrypt-message').value;
            const resultBox = document.getElementById('encrypt-result');

            if (!recipient || !message) {
                showResult(resultBox, 'error', 'Please enter both recipient and message');
                return;
            }

            try {
                const response = await fetch('/api/encrypt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({recipient, message})
                });

                const data = await response.json();

                if (response.ok) {
                    lastEncryptedEnvelope = data.envelope;
                    document.getElementById('decrypt-envelope').value = JSON.stringify(data.envelope, null, 2);
                    
                    showResult(resultBox, 'success',
                        `<h4>Encryption Successful</h4>
                        <p><strong>Recipient:</strong> ${data.recipient}</p>
                        
                        <h5 style="margin-top: 12px; color: #2c3e50; font-size: 0.95em;">Statistics:</h5>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h5>Message Size</h5>
                                <p>${data.stats.message_length} bytes</p>
                            </div>
                            <div class="stat-card">
                                <h5>Ciphertext</h5>
                                <p>${data.stats.ciphertext_length} bytes</p>
                            </div>
                            <div class="stat-card">
                                <h5>Overhead</h5>
                                <p>${data.stats.overhead} bytes</p>
                            </div>
                            <div class="stat-card">
                                <h5>MAC Tag</h5>
                                <p>${data.stats.mac_tag_length} bytes</p>
                            </div>
                        </div>

                        <h5 style="margin-top: 12px; color: #2c3e50; font-size: 0.95em;">Encrypted Envelope:</h5>
                        <div class="code-block">${JSON.stringify(data.envelope, null, 2)}</div>
                        
                        <p style="margin-top: 8px; font-size: 0.85em; color: #666;">
                            Envelope copied to Decrypt tab automatically.
                        </p>`
                    );
                } else {
                    showResult(resultBox, 'error', `<h4>Error</h4><p>${data.error}</p>`);
                }
            } catch (error) {
                showResult(resultBox, 'error', `<h4>‚ùå Error</h4><p>${error.message}</p>`);
            }
        }

        async function decryptMessage() {
            const identity = document.getElementById('decrypt-identity').value;
            const envelopeText = document.getElementById('decrypt-envelope').value;
            const resultBox = document.getElementById('decrypt-result');

            if (!identity || !envelopeText) {
                showResult(resultBox, 'error', 'Please enter both identity and envelope');
                return;
            }

            let envelope;
            try {
                envelope = JSON.parse(envelopeText);
            } catch (e) {
                showResult(resultBox, 'error', 'Invalid JSON envelope format');
                return;
            }

            try {
                const response = await fetch('/api/decrypt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({identity, envelope})
                });

                const data = await response.json();

                if (response.ok) {
                    showResult(resultBox, 'success',
                        `<h4>Decryption Successful</h4>
                        <p><strong>Identity:</strong> ${data.identity}</p>
                        <h5 style="margin-top: 12px; color: #2c3e50; font-size: 0.95em;">Decrypted Message:</h5>
                        <div class="code-block" style="background: #d4edda; color: #155724;">
                            ${data.decrypted_message}
                        </div>`
                    );
                } else {
                    showResult(resultBox, 'error', `<h4>Error</h4><p>${data.error}</p>`);
                }
            } catch (error) {
                showResult(resultBox, 'error', `<h4>‚ùå Error</h4><p>${error.message}</p>`);
            }
        }

        async function requestDemoOTP() {
            const recipient = document.getElementById('demo-recipient').value;
            const resultBox = document.getElementById('demo-otp-result');

            try {
                const response = await fetch('/api/request_otp', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({identity: recipient})
                });

                const data = await response.json();

                if (response.ok) {
                    showResult(resultBox, 'success',
                        `<h4>OTP Sent</h4>
                        <p>${data.message}</p>
                        <p style="margin-top: 8px;"><strong>Check SMTP console for code, then continue below.</strong></p>`
                    );
                    document.getElementById('demo-continue-section').style.display = 'block';
                } else {
                    showResult(resultBox, 'error', `<h4>Error</h4><p>${data.error}</p>`);
                }
            } catch (error) {
                showResult(resultBox, 'error', `<h4>‚ùå Error</h4><p>${error.message}</p>`);
            }
        }

        async function runCompleteDemo() {
            const recipient = document.getElementById('demo-recipient').value;
            const message = document.getElementById('demo-message').value;
            const otp = document.getElementById('demo-otp').value;
            const resultBox = document.getElementById('demo-result');

            if (!recipient || !message || !otp) {
                showResult(resultBox, 'error', 'Please fill in all fields');
                return;
            }

            try {
                const response = await fetch('/api/demo_flow', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({recipient, message, otp})
                });

                const data = await response.json();

                if (response.ok) {
                    const match = data.data.match;
                    showResult(resultBox, 'success',
                        `<h4>Complete Flow Executed</h4>
                        
                        <h5 style="margin-top: 12px; color: #2c3e50; font-size: 0.95em;">Workflow Steps:</h5>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 8px; font-size: 0.9em;">
                            <p style="margin: 4px 0;">‚úì ${data.steps['1_extract']}</p>
                            <p style="margin: 4px 0;">‚úì ${data.steps['2_encrypt']}</p>
                            <p style="margin: 4px 0;">‚úì ${data.steps['3_decrypt']}</p>
                            <p style="margin: 4px 0;">‚úì ${data.steps['4_verify']}</p>
                        </div>

                        <h5 style="margin-top: 12px; color: #2c3e50; font-size: 0.95em;">Verification:</h5>
                        <div class="stats-grid">
                            <div class="stat-card" style="grid-column: 1 / -1;">
                                <h5>Original</h5>
                                <p style="font-size: 0.9em; word-break: break-word;">${data.data.original_message}</p>
                            </div>
                            <div class="stat-card" style="grid-column: 1 / -1;">
                                <h5>Decrypted</h5>
                                <p style="font-size: 0.9em; word-break: break-word;">${data.data.decrypted_message}</p>
                            </div>
                            <div class="stat-card" style="grid-column: 1 / -1; ${match ? 'border-left-color: #27ae60;' : 'border-left-color: #dc3545;'}">
                                <h5>Status</h5>
                                <p style="color: ${match ? '#27ae60' : '#dc3545'};">${match ? '‚úì VERIFIED' : '‚úó FAILED'}</p>
                            </div>
                        </div>

                        <h5 style="margin-top: 12px; color: #2c3e50; font-size: 0.95em;">Encrypted Envelope:</h5>
                        <div class="code-block">${JSON.stringify(data.data.envelope, null, 2)}</div>`
                    );
                } else {
                    showResult(resultBox, 'error', `<h4>Error</h4><p>${data.error}</p>`);
                }
            } catch (error) {
                showResult(resultBox, 'error', `<h4>‚ùå Error</h4><p>${error.message}</p>`);
            }
        }

        function showResult(element, type, content) {
            element.className = `result-box ${type}`;
            element.innerHTML = content;
            element.style.display = 'block';
            element.scrollIntoView({behavior: 'smooth', block: 'nearest'});
        }
    </script>
</body>
</html>
